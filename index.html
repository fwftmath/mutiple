<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Math Arena</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Black+Ops+One&family=Roboto+Mono:wght@500;700&display=swap');
        
        body { background-color: #050510; color: white; touch-action: none; user-select: none; font-family: 'Roboto Mono', monospace; overflow: hidden; overscroll-behavior-y: contain; }
        .font-display { font-family: 'Black Ops One', cursive; }
        .neon-text { text-shadow: 0 0 10px #22d3ee; }
        .neon-gold { text-shadow: 0 0 20px #fbbf24; }
        
        /* Lane & Progress */
        .lane-item { position: absolute; left: 0; right: 0; transition: top 0.5s ease-in-out; }
        .progress-bar { transition: width 0.3s linear; }
        
        /* === BUTTON GLOW SYSTEM === */
        .glow-btn {
            @apply border-2 border-slate-700 text-slate-500 rounded-xl font-bold transition-all bg-slate-800/50 relative overflow-hidden flex flex-col items-center justify-center py-4 text-xs md:text-sm uppercase tracking-wider;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
        }
        .glow-btn:hover { @apply bg-slate-800 border-slate-600 text-slate-300; }
        
        /* 1. Topic (Cyan) */
        .glow-btn.cyan.active { 
            @apply border-cyan-400 text-white bg-cyan-950/90;
            box-shadow: 0 0 20px rgba(34, 211, 238, 0.4), inset 0 0 10px rgba(34, 211, 238, 0.1);
            transform: scale(1.02); z-index: 1;
        }

        /* 2. Mode (Green) */
        .glow-btn.green.active { 
            @apply border-green-400 text-white bg-green-950/90;
            box-shadow: 0 0 20px rgba(74, 222, 128, 0.4), inset 0 0 10px rgba(74, 222, 128, 0.1);
            transform: scale(1.02); z-index: 1;
        }

        /* 3. Pool (Orange) */
        .glow-btn.orange.active { 
            @apply border-orange-400 text-white bg-orange-950/90;
            box-shadow: 0 0 20px rgba(251, 146, 60, 0.4), inset 0 0 10px rgba(251, 146, 60, 0.1);
            transform: scale(1.02); z-index: 1;
        }

        /* Main Action Button */
        .btn-primary { @apply bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-3 px-6 rounded-lg shadow-[0_0_15px_rgba(8,145,178,0.5)] transform transition active:scale-95 w-full mb-3; }
        
        /* === AVATAR AREA (Full Height) === */
        .avatar-grid-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            flex: 1;
            overflow-y: auto; 
            padding: 4px;
            scrollbar-width: none; 
            -ms-overflow-style: none;
        }
        .avatar-grid-container::-webkit-scrollbar { display: none; }

        .avatar-btn { 
            @apply text-6xl p-1 rounded-xl border-2 border-slate-700 transition-all cursor-pointer grayscale opacity-60 bg-slate-800 flex justify-center items-center h-24 w-24 mx-auto shadow-md; 
        }
        .avatar-btn.selected { 
            @apply bg-yellow-900/40 grayscale-0 opacity-100 scale-105 z-10; 
            border-color: #fbbf24; 
            box-shadow: 0 0 25px 5px rgba(251, 191, 36, 0.5); 
        }
        .avatar-btn.taken { @apply opacity-20 cursor-not-allowed border-red-900 bg-slate-900 scale-90 grayscale; }

        /* Z-Index Layers */
        #view-game { z-index: 10; }
        #view-podium { z-index: 200 !important; background-color: #050510; }
        #view-rankings { z-index: 201 !important; background-color: #050510; }
        
        .podium-enter { opacity: 1 !important; transform: translateY(0) !important; visibility: visible !important; transition: all 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .podium-hidden { opacity: 0; transform: translateY(50px); visibility: hidden; }
    </style>
</head>
<body class="h-screen flex flex-col items-center justify-center bg-[#050510]">

    <div id="view-menu" class="text-center space-y-6 p-4 max-w-md w-full hidden z-50">
        <h1 class="text-5xl font-display italic text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-purple-500 mb-2 neon-text">MATH<br>ARENA</h1>
        <div id="db-status" class="text-xs text-red-500 font-bold mb-4">üî¥ Connecting...</div>
        <button onclick="setupHost()" class="btn-primary border-l-4 border-cyan-300 text-xl py-6">üì° HOST CLASS</button>
    </div>

    <div id="view-host-lobby" class="w-full h-full p-4 hidden flex-col max-w-6xl mx-auto">
        <h2 class="text-2xl text-cyan-400 font-display mb-2 border-b border-slate-700 pb-1">CLASSROOM CONTROL</h2>
        <div class="grid grid-cols-1 md:grid-cols-12 gap-4 h-full">
            <div class="md:col-span-5 bg-slate-900 p-4 rounded-xl border border-slate-700 flex flex-col items-center relative">
                <div class="bg-white p-2 rounded-lg mb-2"><div id="qrcode"></div></div>
                <div class="text-xl font-bold text-white mb-2" id="join-count-display">0 STUDENTS</div>
                <div id="player-grid" class="mt-2 flex flex-wrap justify-center gap-2 w-full max-h-60 overflow-y-auto content-start"></div>
            </div>
            
            <div class="md:col-span-7 bg-slate-900 p-4 rounded-xl border border-slate-700 flex flex-col overflow-y-auto">
                
                <div class="mb-5">
                    <label class="block text-slate-400 text-xs mb-2 font-bold uppercase tracking-widest">1. Select Topic</label>
                    <div class="grid grid-cols-3 gap-3">
                        <button class="glow-btn cyan active" onclick="setTopic('integers')" id="btn-topic-integers">üî¢ Integers</button>
                        <button class="glow-btn cyan" onclick="setTopic('algebra')" id="btn-topic-algebra">‚úñÔ∏è Algebra</button>
                        <button class="glow-btn cyan" onclick="setTopic('percent')" id="btn-topic-percent">ÔºÖ Percent</button>
                        
                        <button class="glow-btn cyan" onclick="setTopic('area')" id="btn-topic-area">üü¶ Area</button>
                        <button class="glow-btn cyan" onclick="setTopic('volume')" id="btn-topic-volume">üßä Volume</button>
                        
                        <button class="glow-btn cyan" onclick="setTopic('angles')" id="btn-topic-angles">üìê Angles</button>
                        <button class="glow-btn cyan" onclick="setTopic('factors')" id="btn-topic-factors">‚ûó Factors</button>
                        
                        <button class="glow-btn cyan col-span-2" onclick="setTopic('mixed')" id="btn-topic-mixed">üé≤ F1 Mixed</button>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4 mb-5">
                    <div>
                        <label class="block text-slate-400 text-xs mb-2 font-bold uppercase tracking-widest">2. End Condition</label>
                        <div class="grid grid-cols-2 gap-2">
                            <button class="glow-btn green active" onclick="setMode('time')" id="btn-mode-time">‚è±Ô∏è Time</button>
                            <button class="glow-btn green" onclick="setMode('score')" id="btn-mode-score">üèÅ Score</button>
                        </div>
                    </div>
                    <div>
                        <label class="block text-slate-400 text-xs mb-2 font-bold uppercase tracking-widest">3. Question Pool</label>
                        <div class="grid grid-cols-2 gap-2">
                            <button class="glow-btn orange" onclick="setSync('random')" id="btn-sync-random">üîÄ Random</button>
                            <button class="glow-btn orange active" onclick="setSync('sequence')" id="btn-sync-sequence">üìú Same Set</button>
                        </div>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block text-slate-400 text-xs mb-2 font-bold uppercase" id="setting-label">TIME LIMIT</label>
                    <input type="range" id="setting-slider" class="w-full h-2 bg-slate-700 rounded-lg cursor-pointer accent-cyan-500">
                    <div class="text-right text-cyan-400 text-xl font-bold mt-1" id="setting-value">60 SEC</div>
                </div>

                <button id="btn-host-start" onclick="hostStartGame()" class="btn-primary mt-auto bg-gradient-to-r from-green-500 to-emerald-600 text-xl py-3" disabled>‚è≥ WAIT FOR STUDENTS</button>
            </div>
        </div>
    </div>

    <div id="view-host-game" class="w-full h-full p-4 hidden flex-col bg-slate-950 relative">
        <div class="flex justify-between items-center mb-4 px-4 py-2 bg-slate-900/80 rounded-lg border border-slate-700">
            <div class="font-display text-2xl italic text-slate-300">LEADERBOARD</div>
            <div class="text-4xl font-mono font-bold text-cyan-400 neon-text" id="host-timer-display">00:00</div>
            <div class="text-sm text-slate-500 font-bold" id="host-target-display">TIME LEFT</div>
        </div>
        <div class="flex-1 relative mx-4 rounded-xl bg-slate-900/30 border border-slate-800 overflow-y-auto" id="lanes-container"></div>
        <div id="host-status-msg" class="absolute bottom-10 left-0 w-full text-center pointer-events-none opacity-0 transition-opacity duration-500">
            <span class="bg-black/80 text-yellow-400 px-6 py-2 rounded-full text-xl font-bold border border-yellow-500 shadow-lg">üõë CALCULATING RESULTS...</span>
        </div>
    </div>

    <div id="view-join" class="text-center p-6 max-w-md w-full hidden z-50">
        <h2 class="text-2xl font-bold mb-6 text-cyan-400">YOUR NAME</h2>
        <input type="text" id="player-name" placeholder="NAME" maxlength="8" class="w-full p-4 rounded bg-slate-900 border-2 border-slate-700 text-white text-center text-xl mb-4 focus:border-cyan-500 uppercase font-display">
        <button onclick="goToAvatarSelect()" class="btn-primary">NEXT</button>
    </div>

    <div id="view-avatar-select" class="text-center p-4 w-full max-w-2xl hidden z-50 flex-col h-screen">
        <h2 class="text-xl font-bold mb-2 text-cyan-400 shrink-0">CHOOSE AVATAR</h2>
        <div class="avatar-grid-container mb-2 w-full" id="avatar-grid"></div>
        <div class="shrink-0 w-full pt-2 border-t border-slate-800">
            <button onclick="confirmJoin()" class="btn-primary py-4 text-xl" id="btn-join-confirm" disabled>READY</button>
            <button onclick="showView('view-join')" class="text-slate-500 underline mt-2">BACK</button>
        </div>
    </div>

    <div id="view-student-wait" class="text-center p-6 w-full hidden z-50">
        <div class="text-6xl mb-4 animate-bounce">‚è≥</div>
        <h2 class="text-2xl font-bold text-white mb-2">WAITING...</h2>
        <div class="mt-8 p-6 bg-slate-900 rounded-xl border border-slate-700 flex flex-col items-center shadow-[0_0_20px_rgba(0,0,0,0.5)]">
            <div id="my-final-avatar" class="text-8xl mb-4 p-4 rounded-full bg-slate-800 border-2 border-cyan-500 shadow-[0_0_15px_rgba(34,211,238,0.4)]"></div>
            <span id="my-final-name" class="font-bold text-3xl text-cyan-400 font-display"></span>
            <div class="mt-4 text-slate-500 text-sm">Look at the big screen</div>
        </div>
    </div>

    <div id="view-game" class="w-full h-full flex flex-col hidden relative bg-slate-900">
        <div id="game-freeze-overlay" class="absolute inset-0 bg-slate-950/95 z-40 hidden flex flex-col items-center justify-center">
            <div class="text-6xl mb-4">üõë</div>
            <h2 class="text-4xl font-display text-red-500 mb-2 neon-text">TIME UP!</h2>
        </div>
        <div class="h-12 bg-slate-950 border-b border-slate-800 flex justify-between items-center px-4">
            <div class="text-cyan-400 font-bold" id="client-score">0 PTS</div>
            <div class="text-slate-400 font-mono" id="client-timer-display">--:--</div>
        </div>
        <div class="flex-1 relative flex justify-center items-center" id="canvas-container">
            <canvas id="gameCanvas"></canvas>
            <div id="feedback-msg" class="absolute top-1/3 left-1/2 -translate-x-1/2 text-4xl font-black opacity-0 pointer-events-none z-30"></div>
        </div>
        <div class="bg-slate-900 border-t border-slate-800 p-2 h-[45vh] grid grid-rows-[auto_1fr] gap-2 z-10 shrink-0">
            <div class="bg-slate-800/50 rounded p-2 flex flex-col justify-center items-center relative border border-slate-700">
                <div id="input-display" class="text-3xl font-mono font-bold tracking-[0.2em] text-white">_</div>
            </div>
            <div class="grid grid-cols-4 gap-1 h-full pb-safe">
                <button class="bg-slate-800 text-cyan-100 rounded text-xl font-bold active:bg-cyan-700" onclick="input('7')">7</button>
                <button class="bg-slate-800 text-cyan-100 rounded text-xl font-bold active:bg-cyan-700" onclick="input('8')">8</button>
                <button class="bg-slate-800 text-cyan-100 rounded text-xl font-bold active:bg-cyan-700" onclick="input('9')">9</button>
                <button class="bg-slate-700 text-red-300 rounded text-xl font-bold active:bg-red-900" onclick="input('DEL')">‚å´</button>
                
                <button class="bg-slate-800 text-cyan-100 rounded text-xl font-bold active:bg-cyan-700" onclick="input('4')">4</button>
                <button class="bg-slate-800 text-cyan-100 rounded text-xl font-bold active:bg-cyan-700" onclick="input('5')">5</button>
                <button class="bg-slate-800 text-cyan-100 rounded text-xl font-bold active:bg-cyan-700" onclick="input('6')">6</button>
                <button class="bg-slate-700 text-yellow-300 rounded text-xl font-bold active:bg-slate-600" onclick="input('-')">(-)</button>
                
                <button class="bg-slate-800 text-cyan-100 rounded text-xl font-bold active:bg-cyan-700" onclick="input('1')">1</button>
                <button class="bg-slate-800 text-cyan-100 rounded text-xl font-bold active:bg-cyan-700" onclick="input('2')">2</button>
                <button class="bg-slate-800 text-cyan-100 rounded text-xl font-bold active:bg-cyan-700" onclick="input('3')">3</button>
                <button class="bg-slate-700 text-yellow-300 rounded text-xl font-bold active:bg-slate-600" onclick="input('.')">.</button>
                
                <button class="col-span-2 bg-slate-800 text-cyan-100 rounded text-xl font-bold active:bg-cyan-700" onclick="input('0')">0</button>
                <button class="col-span-2 bg-gradient-to-b from-emerald-600 to-emerald-800 text-white rounded font-bold text-xl active:translate-y-1" onclick="checkAnswer()">ENTER</button>
            </div>
        </div>
    </div>

    <div id="view-podium" class="text-center w-full hidden absolute inset-0 flex flex-col items-center justify-center">
        <h1 class="text-5xl font-display text-transparent bg-clip-text bg-gradient-to-b from-yellow-300 to-yellow-600 mb-12 neon-gold z-10">CHAMPIONS</h1>
        <div class="flex items-end justify-center w-full max-w-4xl px-2 z-10" id="podium-container">
            <div id="podium-2" class="podium-hidden flex flex-col items-center mx-1 md:mx-4">
                <div class="text-5xl mb-2" id="p2-avatar"></div>
                <div class="text-white font-bold text-sm truncate w-20 md:w-32" id="p2-name"></div>
                <div class="w-20 md:w-32 h-32 bg-slate-700 rounded-t-lg border-t-4 border-slate-400 flex items-end justify-center pb-2 shadow-lg">
                    <span class="text-3xl font-black text-slate-500" id="p2-rank-display">2</span>
                </div>
                <div class="mt-2 text-cyan-400 font-bold" id="p2-score"></div>
            </div>
            <div id="podium-1" class="podium-hidden flex flex-col items-center mx-1 md:mx-4 z-20">
                <div class="text-8xl mb-2 animate-bounce" id="p1-avatar"></div>
                <div class="text-yellow-400 font-bold text-xl neon-gold truncate w-24 md:w-40" id="p1-name"></div>
                <div class="w-24 md:w-40 h-48 bg-gradient-to-b from-yellow-600 to-yellow-800 rounded-t-lg border-t-4 border-yellow-400 flex items-end justify-center pb-4 shadow-[0_0_30px_rgba(234,179,8,0.4)]">
                    <span class="text-5xl font-black text-yellow-900/50" id="p1-rank-display">1</span>
                </div>
                <div class="mt-2 text-yellow-400 text-2xl font-black" id="p1-score"></div>
            </div>
            <div id="podium-3" class="podium-hidden flex flex-col items-center mx-1 md:mx-4">
                <div class="text-5xl mb-2" id="p3-avatar"></div>
                <div class="text-white font-bold text-sm truncate w-20 md:w-32" id="p3-name"></div>
                <div class="w-20 md:w-32 h-24 bg-orange-900 rounded-t-lg border-t-4 border-orange-700 flex items-end justify-center pb-2 shadow-lg">
                    <span class="text-3xl font-black text-orange-900/50" id="p3-rank-display">3</span>
                </div>
                <div class="mt-2 text-cyan-400 font-bold" id="p3-score"></div>
            </div>
        </div>
    </div>

    <div id="view-rankings" class="w-full h-full hidden absolute inset-0 flex flex-col p-6">
        <h2 class="text-3xl font-display text-cyan-400 text-center mb-6">FINAL RESULTS</h2>
        <div class="flex-1 overflow-y-auto bg-slate-900/50 rounded-xl border border-slate-800 p-4 max-w-2xl mx-auto w-full">
            <table class="w-full text-left border-collapse">
                <thead class="text-slate-500 border-b border-slate-700">
                    <tr><th class="p-2">#</th><th class="p-2">STUDENT</th><th class="p-2 text-right">SCORE</th></tr>
                </thead>
                <tbody id="ranking-list-body"></tbody>
            </table>
        </div>
        <div id="host-restart-area" class="mt-4 text-center hidden">
            <button onclick="backToMenu()" class="btn-primary max-w-xs bg-slate-700 hover:bg-slate-600 border border-slate-500">üè† NEW CLASS</button>
        </div>
    </div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyAYnQB2o5cPn42RiNAik7537ihduICJwdQ",
        authDomain: "fwftmath.firebaseapp.com",
        projectId: "fwftmath",
        storageBucket: "fwftmath.firebasestorage.app",
        messagingSenderId: "70090299689",
        appId: "1:70090299689:web:ae300db1f79a3eda62bf38"
    };

    let app, db;
    const savedPid = sessionStorage.getItem('ma_pid');
    const savedName = sessionStorage.getItem('ma_name');
    const savedAvatar = sessionStorage.getItem('ma_avatar');
    
    let state = {
        role: 'none', 
        gameId: new URLSearchParams(window.location.search).get('gid'),
        playerId: savedPid || ('p_' + Math.random().toString(36).substr(2,6)),
        playerName: savedName || 'Guest', 
        avatar: savedAvatar || '',
        score: 0, 
        active: false,
        settings: { mode: 'time', target: 60, topic: 'integers', sync: 'sequence' }, 
        q: null,
        input: '', 
        endTime: 0,
        hostLoop: null,
        sharedQuestions: [],
        currentQIndex: 0
    };

    let localTimerInterval = null;
    const views = ['view-menu','view-host-lobby','view-host-game','view-join','view-avatar-select','view-student-wait','view-game','view-podium','view-rankings'];
    
    const AVATAR_OPTIONS = [
        'üêØ','üê∞','ü¶Å','ü¶Ñ','ü¶ñ','üëΩ','ü§ñ','üêº','ü¶ä','üê®','üêÆ','üê∑',
        'üê∏','üêµ','üêî','üêß','üê¶','üê§','ü¶Ü','ü¶Ö','ü¶â','ü¶á','üê∫','üêó',
        'üê¥','üêù','üêõ','ü¶ã','üêå','üêû','üêú','ü¶ü','ü¶ó','üï∑','ü¶Ç','üê¢'
    ];
    
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function playTone(f,t,d){if(audioCtx.state==='suspended')audioCtx.resume();const o=audioCtx.createOscillator(),g=audioCtx.createGain();o.type=t;o.frequency.value=f;o.connect(g);g.connect(audioCtx.destination);o.start();g.gain.exponentialRampToValueAtTime(0.0001,audioCtx.currentTime+d);o.stop(audioCtx.currentTime+d);}

    function showView(id) {
        views.forEach(v => {
            const el = document.getElementById(v);
            if(el) el.classList.add('hidden');
        });
        document.getElementById(id).classList.remove('hidden');
        if(id.includes('host') || id === 'view-avatar-select' || id === 'view-rankings' || id === 'view-podium') document.getElementById(id).classList.add('flex');
        if(id === 'view-game') resizeCanvas();
    }

    window.addEventListener('load', () => {
        try {
            app = firebase.initializeApp(firebaseConfig);
            db = firebase.database();
            db.ref(".info/connected").on("value", (snap) => {
                const statusEl = document.getElementById('db-status');
                if(statusEl) {
                    statusEl.innerText = snap.val() ? "üü¢ ONLINE" : "üü† CONNECTING...";
                    statusEl.className = snap.val() ? "text-xs text-green-400 font-bold mb-4" : "text-xs text-orange-400 font-bold mb-4";
                }
            });

            if (state.gameId && savedPid) {
                confirmJoin(true); 
            } else if (state.gameId) {
                showView('view-join');
            } else {
                showView('view-menu');
            }
        } catch (e) { console.error(e); }
    });

    // ================= HOST LOGIC =================
    function setupHost() {
        if (!db) return alert("Database not ready.");
        state.role = 'host';
        showView('view-host-lobby');
        
        const slider = document.getElementById('setting-slider');
        slider.oninput = () => updateSettingsDisplay();
        
        setMode('time');
        setTopic('integers');
        setSync('sequence');

        const ref = db.ref('games').push();
        state.gameId = ref.key;
        ref.set({ status: 'lobby', createdAt: Date.now(), settings: state.settings });
        
        const qrDiv = document.getElementById("qrcode");
        qrDiv.innerHTML = "";
        new QRCode(qrDiv, { text: `${location.origin}${location.pathname}?gid=${state.gameId}`, width: 128, height: 128 });
        
        db.ref(`games/${state.gameId}/players`).on('value', snap => {
            const grid = document.getElementById('player-grid');
            grid.innerHTML = '';
            let count = 0;
            snap.forEach(c => {
                count++;
                const p = c.val();
                grid.innerHTML += `<div class="bg-slate-800 px-3 py-2 rounded-lg border border-slate-600 text-sm flex items-center gap-2 animate-[pop_0.3s]"><span class="text-xl">${p.avatar}</span><span class="font-bold text-white">${p.name}</span><button onclick="kickPlayer('${c.key}')" class="kick-btn text-red-500 ml-2">‚ùå</button></div>`;
            });
            document.getElementById('join-count-display').innerText = `${count} STUDENTS`;
            
            const startBtn = document.getElementById('btn-host-start');
            if(count < 1) { 
                startBtn.disabled = true;
                startBtn.innerHTML = `‚è≥ WAIT (${count})`;
                startBtn.className = "btn-primary mt-auto bg-slate-700 text-slate-500 cursor-not-allowed opacity-50";
            } else {
                startBtn.disabled = false;
                startBtn.innerHTML = "üöÄ START CLASS";
                startBtn.className = "btn-primary mt-auto bg-gradient-to-r from-green-500 to-emerald-600 text-xl py-3";
            }
        });
    }

    window.kickPlayer = (pid) => { if(confirm("Remove student?")) db.ref(`games/${state.gameId}/players/${pid}`).remove(); };

    function setTopic(topic) {
        state.settings.topic = topic;
        document.querySelectorAll('#view-host-lobby .cyan').forEach(btn => btn.classList.remove('active'));
        document.getElementById(`btn-topic-${topic}`).classList.add('active');
        if(state.gameId) db.ref(`games/${state.gameId}/settings`).update(state.settings);
    }

    function setMode(mode) {
        state.settings.mode = mode;
        const slider = document.getElementById('setting-slider');
        document.querySelectorAll('#view-host-lobby .green').forEach(btn => btn.classList.remove('active'));
        document.getElementById(`btn-mode-${mode}`).classList.add('active');

        if(mode==='score') { 
            document.getElementById('setting-label').innerText="TARGET SCORE"; slider.min=500; slider.max=5000; slider.step=100; slider.value=1000; 
        } else { 
            document.getElementById('setting-label').innerText="TIME LIMIT"; slider.min=20; slider.max=180; slider.step=10; slider.value=60; 
        }
        updateSettingsDisplay();
        if(state.gameId) db.ref(`games/${state.gameId}/settings`).update(state.settings);
    }

    function setSync(type) {
        state.settings.sync = type;
        document.querySelectorAll('#view-host-lobby .orange').forEach(btn => btn.classList.remove('active'));
        document.getElementById(`btn-sync-${type}`).classList.add('active');
        if(state.gameId) db.ref(`games/${state.gameId}/settings`).update(state.settings);
    }

    function updateSettingsDisplay() {
        const slider = document.getElementById('setting-slider');
        state.settings.target = parseInt(slider.value);
        document.getElementById('setting-value').innerText = state.settings.mode==='score' ? state.settings.target+" PTS" : state.settings.target+" SEC";
        if(state.gameId) db.ref(`games/${state.gameId}/settings`).update(state.settings);
    }

    function hostStartGame() {
        const updateData = { status: 'playing', startTime: Date.now() };
        
        if(state.settings.mode === 'time') {
            state.endTime = Date.now() + (state.settings.target * 1000);
            updateData.endTime = state.endTime;
        }

        if(state.settings.sync === 'sequence') {
            const pool = [];
            for(let i=0; i<100; i++) pool.push(createMathProblem(state.settings.topic, 0)); 
            updateData.questionPool = pool;
        }

        db.ref(`games/${state.gameId}`).update(updateData);
        showView('view-host-game');
        document.getElementById('host-target-display').innerText = state.settings.mode==='score' ? `TARGET: ${state.settings.target}` : "TIME LEFT";
        startLocalTicker(state.settings.mode === 'time' ? state.endTime : null, 'host-timer-display');
        
        if (state.hostLoop) clearInterval(state.hostLoop);
        state.hostLoop = setInterval(() => {
            if (state.settings.mode === 'time' && Date.now() >= state.endTime) {
                clearInterval(state.hostLoop);
                executeGameFinish();
            }
        }, 1000);
        
        monitorGameUpdates();
    }

    function monitorGameUpdates() {
        const gameRef = db.ref(`games/${state.gameId}`);
        gameRef.on('value', snap => {
            const game = snap.val();
            if(!game) return;

            if (game.status === 'results') {
                if(game.finalStandings) showPodiumSequence(game.finalStandings);
                gameRef.off(); 
                if (state.hostLoop) clearInterval(state.hostLoop);
            }

            if(game.players) {
                const players = Object.values(game.players).sort((a,b)=>(b.score||0)-(a.score||0));
                
                if (state.role==='host' && game.status==='playing' && game.settings.mode==='score' && players[0].score >= game.settings.target) {
                    executeGameFinish();
                }

                renderLanes(players, game.settings.target, game.settings.mode);
            }
        });
    }

    function executeGameFinish() {
        db.ref(`games/${state.gameId}`).update({ status: 'finished' });
        document.getElementById('host-status-msg').style.opacity = 1;
        if(localTimerInterval) clearInterval(localTimerInterval);

        setTimeout(() => {
            db.ref(`games/${state.gameId}/players`).once('value', s => {
                const arr = [];
                s.forEach(c => {
                    const p = c.val();
                    p.score = parseInt(p.score) || 0;
                    arr.push(p);
                });
                arr.sort((a,b) => b.score - a.score);
                let currentRank = 1;
                for(let i=0; i<arr.length; i++) {
                    if (i > 0 && arr[i].score < arr[i-1].score) currentRank++;
                    arr[i].rank = currentRank;
                }
                db.ref(`games/${state.gameId}`).update({ status: 'results', finalStandings: arr });
            });
        }, 1500);
    }

    function renderLanes(players, target, mode) {
        const container = document.getElementById('lanes-container');
        const topScore = players[0]?.score || 1;
        const scaleBase = mode === 'score' ? target : Math.max(1000, topScore * 1.2);

        players.forEach((p, index) => {
            let el = document.getElementById(`lane-${p.name}`);
            const pct = Math.min(100, ((p.score||0)/scaleBase)*100);
            if (!el) {
                el = document.createElement('div');
                el.id = `lane-${p.name}`;
                el.className = 'lane-item h-12 bg-slate-800/80 rounded flex items-center px-2 border border-slate-700 shadow mx-2';
                el.style.width = "calc(100% - 32px)";
                el.innerHTML = `<div class="w-10 text-2xl mr-2 text-center">${p.avatar}</div><div class="w-24 font-bold text-white truncate text-sm">${p.name}</div><div class="flex-1 h-4 bg-slate-900 rounded-full overflow-hidden mx-2 border border-slate-600"><div class="progress-bar h-full bg-gradient-to-r from-cyan-500 to-blue-500" style="width: 0%"></div></div><div class="w-16 text-right font-mono text-cyan-400 font-bold score-txt">0</div>`;
                container.appendChild(el);
            }
            el.style.top = (index * 60 + 10) + 'px';
            el.querySelector('.progress-bar').style.width = pct + '%';
            el.querySelector('.score-txt').innerText = p.score || 0;
            if(index===0) el.classList.add('border-yellow-500'); else el.classList.remove('border-yellow-500');
        });
    }

    // ================= CLIENT LOGIC =================
    function goToAvatarSelect() {
        const name = document.getElementById('player-name').value.trim();
        if(!name) return alert("Enter Name!");
        state.playerName = name;
        showView('view-avatar-select');
        
        const grid = document.getElementById('avatar-grid');
        grid.innerHTML = '';
        AVATAR_OPTIONS.forEach((av, idx) => {
            const btn = document.createElement('div');
            btn.className = 'avatar-btn';
            btn.id = `av-btn-${idx}`;
            btn.innerHTML = `<span>${av}</span>`;
            btn.onclick = () => selectAvatar(av, idx);
            grid.appendChild(btn);
        });
        
        db.ref(`games/${state.gameId}/players`).on('value', snap => {
            document.querySelectorAll('.avatar-btn').forEach(b => {
                if(!b.classList.contains('selected')) b.classList.remove('taken');
            });
            snap.forEach(c => {
                const p = c.val();
                if (p.avatar && p.name !== state.playerName) {
                    AVATAR_OPTIONS.forEach((opt, idx) => {
                        if (opt === p.avatar) {
                            const btn = document.getElementById(`av-btn-${idx}`);
                            if(btn) btn.classList.add('taken');
                        }
                    });
                }
            });
        });
    }

    function selectAvatar(av, idx) {
        const btn = document.getElementById(`av-btn-${idx}`);
        if (btn.classList.contains('taken')) return; 
        document.querySelectorAll('.avatar-btn').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
        state.avatar = av;
        document.getElementById('btn-join-confirm').disabled = false;
    }

    function confirmJoin(isReconnect = false) {
        if(!db) return alert("Waiting for connection...");
        sessionStorage.setItem('ma_pid', state.playerId);
        sessionStorage.setItem('ma_name', state.playerName);
        sessionStorage.setItem('ma_avatar', state.avatar);
        sessionStorage.setItem('ma_gid', state.gameId);

        if (!isReconnect) {
            const playerRef = db.ref(`games/${state.gameId}/players/${state.playerId}`);
            playerRef.update({ name: state.playerName, avatar: state.avatar, score: 0 });
        }
        
        db.ref(`games/${state.gameId}/players`).off(); 

        showView('view-student-wait');
        document.getElementById('my-final-avatar').innerText = state.avatar;
        document.getElementById('my-final-name').innerText = state.playerName;
        
        db.ref(`games/${state.gameId}`).on('value', snap => {
            const game = snap.val();
            if(!game) return;
            state.settings = game.settings;
            
            if (game.status === 'playing') {
                if(game.questionPool) state.sharedQuestions = game.questionPool; 
                
                document.getElementById('game-freeze-overlay').classList.add('hidden');
                if (!state.active) {
                    state.active = true;
                    showView('view-game');
                    if(!state.q) generateQuestion(); 
                    startLocalTicker(game.endTime, 'client-timer-display');
                    requestAnimationFrame(gameRenderLoop);
                }
            } 
            else if (game.status === 'finished' || game.status === 'calculating') {
                state.active = false;
                if(localTimerInterval) clearInterval(localTimerInterval);
                document.getElementById('game-freeze-overlay').classList.remove('hidden');
            } 
            else if (game.status === 'results') {
                showPodiumSequence(game.finalStandings);
                db.ref(`games/${state.gameId}`).off(); 
            }
        });
    }

    function startLocalTicker(endTime, elementId) {
        if(localTimerInterval) clearInterval(localTimerInterval);
        const el = document.getElementById(elementId);
        let lastToneSec = -1;
        
        updateTime();
        localTimerInterval = setInterval(updateTime, 200);
        
        function updateTime() {
            if(!endTime) { el.innerText = "RACE"; return; }
            const diff = endTime - Date.now();
            const left = Math.ceil(diff / 1000);
            
            if (left <= 5 && left > 0 && left !== lastToneSec) {
                playTone(600, 'square', 0.1); 
                lastToneSec = left;
            }

            if(left <= 0) {
                el.innerText = "00:00";
                if(state.role !== 'host') clearInterval(localTimerInterval);
                return;
            }
            el.innerText = `${Math.floor(left / 60)}:${(left % 60).toString().padStart(2, '0')}`;
        }
    }

    // ================= MATH ENGINE (V38 UPDATED) =================
    
    function createMathProblem(topic, currentScore = 0) {
        let t = topic;
if (topic === 'mixed') {
    const types = ['integers', 'algebra', 'percent', 'area', 'volume', 'angles', 'factors'];
    t = types[Math.floor(Math.random() * types.length)];
}

        // INTEGERS
        if (t === 'integers') {
            if (currentScore > 800) {
                const a = rInt(-9, 15);
                const b = rInt(-9, 15);
                const c = rInt(-9, 15);
                const ops = ['+','-'];
                const op1 = ops[Math.floor(Math.random()*2)];
                const op2 = ops[Math.floor(Math.random()*2)];
                let res = a;
                if(op1==='+') res+=b; else res-=b;
                if(op2==='+') res+=c; else res-=c;
                return { type: 'text', qText: `${a} ${op1} ${b<0?`(${b})`:b} ${op2} ${c<0?`(${c})`:c} = ?`, a: res };
            } else {
                const a = rInt(-10, 15);
                const b = rInt(-10, 15);
                const op = Math.random() > 0.5 ? '+' : '-';
                const ans = (op === '+') ? a + b : a - b;
                return { type: 'text', qText: `${a} ${op} ${b<0?`(${b})`:b} = ?`, a: ans };
            }
        }
        
        // FACTORS (HCF & LCM) - NEW
        if (t === 'factors') {
            const gcd = (a, b) => !b ? a : gcd(b, a % b);
            const lcm = (a, b) => (a * b) / gcd(a, b);
            if (Math.random() < 0.5) {
                const factor = rInt(2, 9);
                const m1 = rInt(1, 4);
                const m2 = rInt(1, 5);
                const n1 = factor * m1;
                const n2 = factor * (m1 === m2 ? m1 + 1 : m2);
                return { type: 'text', qText: `HCF(${n1}, ${n2}) = ?`, a: gcd(n1, n2) };
            } else {
                const n1 = rInt(2, 8);
                const n2 = rInt(2, 10);
                return { type: 'text', qText: `LCM(${n1}, ${n2}) = ?`, a: lcm(n1, n2) };
            }
        }

// ANGLES
if (t === 'angles') {
    const type = Math.random();
    if (type < 0.3) { // Áõ¥Á∑ö‰∏äÁöÑÈÑ∞Ëßí (180Â∫¶)
        const ang1 = rInt(30, 150);
        return { type: 'geo', shape: 'line_angle', v1: ang1, qText: 'Find x', a: 180 - ang1 };
    } else if (type < 0.5) { // Âêå‰∏ÄÈªûÁöÑÂë®Ëßí (360Â∫¶)
        const ang1 = rInt(90, 140);
        const ang2 = rInt(50, 100);
        return { type: 'geo', shape: 'point_angle', v1: ang1, v2: ang2, qText: 'Find x', a: 360 - ang1 - ang2 };
    } else { // ‰∏âËßíÂΩ¢ÂÖßËßíÂíå (180Â∫¶)
        // Á¢∫‰øùÂÖ©ÂÄãËßíÁõ∏Âä†Â∞èÊñº 170ÔºåÈ†êÁïôÁ©∫ÈñìÁµ¶Á¨¨‰∏âÂÄãËßí x
        const ang1 = rInt(35, 80);
        const ang2 = rInt(35, 80);
        return { type: 'geo', shape: 'tri_angle', v1: ang1, v2: ang2, qText: 'Find x', a: 180 - ang1 - ang2 };
    }
}

        // AREA 
        if (t === 'area') {
            const rand = Math.random();
            if (rand < 0.2) { 
                const s = rInt(3, 12);
                return { type: 'geo', shape: 'square', v1: s, qText: 'Area?', a: s*s };
            } else if (rand < 0.4) { 
                const w = rInt(4, 10);
                const h = rInt(2, 8);
                return { type: 'geo', shape: 'rect', v1: w, v2: h, qText: 'Area?', a: w*h };
            } else if (rand < 0.6) { 
                const b = rInt(4, 10);
                const h = rInt(2, 8);
                return { type: 'geo', shape: 'tri', v1: b, v2: h, qText: 'Area?', a: 0.5*b*h };
            } else if (rand < 0.8) { 
                const b = rInt(4, 12);
                const h = rInt(3, 8);
                return { type: 'geo', shape: 'parallelogram', v1: b, v2: h, qText: 'Area?', a: b*h };
            } else { 
                const top = rInt(3, 8);
                const bot = rInt(6, 12);
                const h = rInt(2, 8);
                return { type: 'geo', shape: 'trapezoid', v1: top, v2: bot, v3: h, qText: 'Area?', a: 0.5*(top+bot)*h };
            }
        }

        // VOLUME
        if (t === 'volume') {
            const rand = Math.random();
            if (rand < 0.4) { 
                const s = rInt(2, 6);
                return { type: 'geo', shape: 'cube', v1: s, qText: 'Volume?', a: s*s*s };
            } else { 
                const l = rInt(3, 6);
                const w = rInt(2, 5);
                const h = rInt(2, 5);
                return { type: 'geo', shape: 'cuboid', v1: l, v2: w, v3: h, qText: 'Volume?', a: l*w*h };
            }
        }
        
        // ALGEBRA
        if (t === 'algebra') {
            const x = rInt(2, 12); 
            if (Math.random() < 0.4) {
                const a = rInt(2, 5);
                return { type: 'text', qText: `${a}x = ${a*x}, x = ?`, a: x };
            } else {
                const a = rInt(2, 4);
                const b = rInt(1, 10);
                return { type: 'text', qText: `${a}x + ${b} = ${a*x+b}, x=?`, a: x };
            }
        }

        // PERCENT
        if (t === 'percent') {
            const base = rInt(1, 10) * 100; 
            const rate = rInt(1, 9) * 10;   
            return { type: 'text', qText: `${rate}% of ${base} = ?`, a: (rate / 100) * base };
        }

        return { type: 'text', qText: "1+1=?", a: 2 };
    }

    function generateQuestion() {
        let p;
        if (state.settings.sync === 'sequence' && state.sharedQuestions.length > 0) {
            p = state.sharedQuestions[state.currentQIndex] || createMathProblem(state.settings.topic, state.score);
        } else {
            p = createMathProblem(state.settings.topic, state.score);
        }
        state.q = p;
        state.input = '';
        updateInputDisplay();
    }

    function rInt(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }

    function input(val) {
        if(!state.active) return;
        if (val === 'DEL') state.input = state.input.slice(0, -1);
        else if (state.input.length < 8) { state.input += val; playTone(800, 'sine', 0.05); }
        updateInputDisplay();
    }

    function updateInputDisplay() {
        document.getElementById('input-display').innerText = state.input === '' ? '_' : state.input;
    }

    function checkAnswer() {
        if(!state.active) return;
        const playerAns = parseFloat(state.input);
        const correct = Math.abs(playerAns - state.q.a) < 0.01;

        if (correct) {
            playTone(1200, 'triangle', 0.1);
            showFeedback('Correct!', 'text-green-400');
            state.score += 100;
            state.currentQIndex++; 
            document.getElementById('client-score').innerText = state.score + " PTS";
            if(state.gameId && state.playerId) db.ref(`games/${state.gameId}/players/${state.playerId}/score`).set(state.score);
            generateQuestion();
        } else {
            playTone(200, 'sawtooth', 0.3);
            showFeedback('Wrong', 'text-red-500');
            state.input = '';
            updateInputDisplay();
            const container = document.getElementById('view-game');
            container.classList.add('animate-[shake_0.3s]');
            setTimeout(() => container.classList.remove('animate-[shake_0.3s]'), 300);
        }
    }

    function showFeedback(text, colorClass) {
        const el = document.getElementById('feedback-msg');
        el.innerText = text;
        el.className = `absolute top-1/3 left-1/2 -translate-x-1/2 text-5xl font-black pointer-events-none z-30 transition-all duration-500 transform scale-150 ${colorClass}`;
        el.style.opacity = 1;
        setTimeout(() => { el.style.opacity = 0; el.style.transform = "translate(-50%, -50%) scale(0.5)"; }, 800);
    }

    // ================= DRAWING =================
    let canvas, ctx;
    function resizeCanvas() {
        canvas = document.getElementById('gameCanvas');
        if(!canvas) return;
        const parent = document.getElementById('canvas-container');
        canvas.width = parent.clientWidth;
        canvas.height = parent.clientHeight;
        ctx = canvas.getContext('2d');
    }
    window.addEventListener('resize', resizeCanvas);

    function gameRenderLoop() {
        if (!state.active) return;
        drawGame();
        requestAnimationFrame(gameRenderLoop);
    }

    function drawGame() {
        if(!ctx || !state.q) return;
        const w = canvas.width, h = canvas.height;

        ctx.fillStyle = '#0f172a';
        ctx.fillRect(0, 0, w, h);
        
        ctx.fillStyle = '#1e293b'; 
        const cardW = Math.min(320, w - 20);
        const cardH = 220;
        const cardX = (w - cardW) / 2;
        const cardY = (h - cardH) / 2;
        
        ctx.beginPath();
        ctx.roundRect(cardX, cardY, cardW, cardH, 20);
        ctx.fill();
        
        const time = Date.now() / 1000;
        ctx.lineWidth = 4;
        ctx.strokeStyle = `rgba(34, 211, 238, ${0.5 + Math.sin(time * 3) * 0.2})`;
        ctx.stroke();

        ctx.fillStyle = 'white';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';

        const cx = w / 2;
        const cy = h / 2;

        if (state.q.type === 'geo') {
            drawGeometryQuestion(cx, cy, state.q);
        } else {
            if (state.q.qText.length > 20) ctx.font = `bold 20px "Roboto Mono"`;
            else if (state.q.qText.length > 15) ctx.font = `bold 24px "Roboto Mono"`;
            else ctx.font = `bold 36px "Roboto Mono"`;
            ctx.fillText(state.q.qText, cx, cy);
        }
    }

    function drawGeometryQuestion(cx, cy, q) {
        ctx.strokeStyle = '#fff';
        ctx.lineWidth = 3;
        ctx.fillStyle = '#22d3ee'; 
        ctx.font = "bold 20px 'Roboto Mono'";

        if (q.shape === 'line_angle') {
            const len = 200;
            ctx.beginPath(); ctx.moveTo(cx - len/2, cy + 50); ctx.lineTo(cx + len/2, cy + 50); ctx.stroke();
            ctx.beginPath(); ctx.arc(cx, cy + 50, 40, Math.PI, 0); ctx.lineWidth = 1; ctx.stroke();
            const rad = (180 - 60) * (Math.PI / 180);
            const xEnd = cx + Math.cos(rad) * 100;
            const yEnd = (cy + 50) - Math.sin(rad) * 100;
            ctx.lineWidth = 4; ctx.beginPath(); ctx.moveTo(cx, cy + 50); ctx.lineTo(xEnd, yEnd); ctx.stroke();
            ctx.fillStyle = '#fbbf24'; ctx.fillText(`${q.v1}¬∞`, cx + 40, cy + 20);
            ctx.fillStyle = '#22d3ee'; ctx.fillText(`x`, cx - 40, cy + 20);
        }
        else if (q.shape === 'point_angle') {
            const r = 90;
            const drawLine = (deg) => {
                const rad = deg * (Math.PI / 180);
                ctx.beginPath(); ctx.moveTo(cx, cy); ctx.lineTo(cx + Math.cos(rad)*r, cy + Math.sin(rad)*r); ctx.stroke();
            };
            drawLine(0); drawLine(130); drawLine(240);
            ctx.fillStyle = '#fff'; ctx.fillText(`${q.v1}¬∞`, cx + 30, cy - 30);
            ctx.fillText(`${q.v2}¬∞`, cx - 40, cy);
            ctx.fillStyle = '#22d3ee'; ctx.fillText(`x`, cx + 20, cy + 40);
        }
else if (q.shape === 'tri_angle') {
    const base = 140, height = 110;
    const left = cx - base/2, right = cx + base/2, topY = cy - height/2, botY = cy + height/2;
    
    // 1. Áπ™Ë£Ω‰∏âËßíÂΩ¢
    ctx.beginPath(); 
    ctx.moveTo(left, botY); 
    ctx.lineTo(right, botY); 
    ctx.lineTo(cx, topY); 
    ctx.closePath(); 
    ctx.stroke();

    // 2. Ê®ôË®ªÂ∑≤Áü•ËßíÂ∫¶ (È†ÇËßí v1 Âíå Âè≥Â∫ïËßí v2)
    ctx.fillStyle = '#fff';
    ctx.font = "bold 20px 'Roboto Mono'";
    ctx.fillText(`${q.v1}¬∞`, cx, topY + 30);
    ctx.fillText(`${q.v2}¬∞`, right - 25, botY - 15);
    
    // 3. Ê®ôË®ªÊú™Áü•Êï∏ x (Â∑¶Â∫ïËßí) - ‰ΩøÁî®ÊñúÈ´îÈ¢®Ê†º‰∏¶Âä†‰∏äÂ∫¶Êï∏Á¨¶Ëôü
    ctx.fillStyle = '#22d3ee'; // ÈùíËâ≤Á™ÅÂá∫È°ØÁ§∫
    ctx.font = "italic bold 24px 'Times New Roman', serif"; // ‰ΩøÁî®Ë•ØÁ∑öÂ≠óÈ´îÊ®°Êì¨Êï∏Â≠∏Ê†ºÂºè
    ctx.fillText(`x¬∞`, left + 25, botY - 15);
}
        else if (q.shape === 'square') {
            const size = 100;
            ctx.strokeRect(cx - size/2, cy - size/2, size, size);
            ctx.fillText(q.v1, cx, cy - size/2 - 15); ctx.fillText(q.v1, cx + size/2 + 15, cy);
        }
        else if (q.shape === 'rect') {
            const rw = 140, rh = 80;
            ctx.strokeRect(cx - rw/2, cy - rh/2, rw, rh);
            ctx.fillText(q.v1, cx, cy - rh/2 - 15); ctx.fillText(q.v2, cx + rw/2 + 15, cy);
        }
        else if (q.shape === 'tri') {
            const base = 120, height = 100; const left = cx - base/2 + 20, bottom = cy + height/2 - 10;
            ctx.beginPath(); ctx.moveTo(left, bottom); ctx.lineTo(left + base, bottom); ctx.lineTo(left, bottom - height); ctx.closePath(); ctx.stroke();
            ctx.beginPath(); ctx.setLineDash([5, 5]); ctx.moveTo(left, bottom); ctx.lineTo(left, bottom - height); ctx.stroke(); ctx.setLineDash([]);
            ctx.fillText(q.v1, left + base/2, bottom + 20); ctx.fillText(q.v2, left - 20, bottom - height/2); 
        }
        else if (q.shape === 'parallelogram') {
            const b = 140, h = 80, slant = 40, x = cx - b/2, y = cy + h/2; 
            ctx.beginPath(); ctx.moveTo(x, y); ctx.lineTo(x + b, y); ctx.lineTo(x + b + slant, y - h); ctx.lineTo(x + slant, y - h); ctx.closePath(); ctx.stroke();
            ctx.beginPath(); ctx.setLineDash([5, 5]); ctx.moveTo(x + slant, y - h); ctx.lineTo(x + slant, y); ctx.stroke(); ctx.setLineDash([]);
            ctx.fillText(q.v1, cx + slant/2, y + 20); ctx.fillText(q.v2, x + slant - 20, cy);   
        }
        else if (q.shape === 'trapezoid') {
            const topW = 80, botW = 160, h = 90, yBot = cy + h/2, yTop = cy - h/2;
            ctx.beginPath(); ctx.moveTo(cx - botW/2, yBot); ctx.lineTo(cx + botW/2, yBot); ctx.lineTo(cx + topW/2, yTop); ctx.lineTo(cx - topW/2, yTop); ctx.closePath(); ctx.stroke();
            ctx.beginPath(); ctx.setLineDash([5, 5]); ctx.moveTo(cx, yTop); ctx.lineTo(cx, yBot); ctx.stroke(); ctx.setLineDash([]);
            ctx.fillText(q.v1, cx, yTop - 20); ctx.fillText(q.v2, cx, yBot + 20); ctx.fillText(q.v3, cx + 15, cy);   
        }
        else if (q.shape === 'cube') {
            const size = 80, offset = 40, x = cx - size/2 - 20, y = cy - size/2 + 20;
            ctx.strokeRect(x, y, size, size); ctx.strokeRect(x + offset, y - offset, size, size);
            ctx.beginPath(); ctx.moveTo(x, y); ctx.lineTo(x + offset, y - offset); ctx.moveTo(x + size, y); ctx.lineTo(x + size + offset, y - offset);
            ctx.moveTo(x, y + size); ctx.lineTo(x + offset, y + size - offset); ctx.moveTo(x + size, y + size); ctx.lineTo(x + size + offset, y + size - offset); ctx.stroke();
            ctx.fillText(q.v1, x + size/2, y + size + 20);
        }
        else if (q.shape === 'cuboid') {
            const w = 100, h = 60, offset = 40, x = cx - w/2 - 20, y = cy - h/2 + 20;
            ctx.strokeRect(x, y, w, h); ctx.strokeRect(x + offset, y - offset, w, h);
            ctx.beginPath(); ctx.moveTo(x, y); ctx.lineTo(x + offset, y - offset); ctx.moveTo(x + w, y); ctx.lineTo(x + w + offset, y - offset);
            ctx.moveTo(x, y + h); ctx.lineTo(x + offset, y + h - offset); ctx.moveTo(x + w, y + h); ctx.lineTo(x + w + offset, y + h - offset); ctx.stroke();
            ctx.fillText(q.v1, x + w/2, y + h + 20); ctx.fillText(q.v2, x + w + offset + 20, y + h/2); ctx.fillText(q.v3, x - 20, y + h/2); 
        }

        ctx.fillStyle = 'white';
        ctx.font = "bold 24px 'Roboto Mono'";
        ctx.fillText(q.qText, cx, cy + 90);
    }

    // ================= PODIUM =================
    function showPodiumSequence(fullList) {
        state.active = false;
        if(localTimerInterval) clearInterval(localTimerInterval);
        showView('view-podium');
        renderPodium(fullList);
        
        const end = Date.now() + 3000;
        (function frame() {
            confetti({ particleCount: 3, angle: 60, spread: 55, origin: { x: 0 } });
            confetti({ particleCount: 3, angle: 120, spread: 55, origin: { x: 1 } });
            if (Date.now() < end) requestAnimationFrame(frame);
        }());

        setTimeout(() => { showFullRankingList(fullList); }, 6000);
    }

    function renderPodium(list) {
        if(!list) list = [];
        const ids = ['podium-1', 'podium-2', 'podium-3'];
        ids.forEach(id => {
            const el = document.getElementById(id);
            el.className = 'podium-hidden flex flex-col items-center mx-1 md:mx-4'; 
            if(id === 'podium-1') el.classList.add('z-20');
        });

        const updateRankNum = (pos, rank) => {
            const map = {0: 'p1-rank-display', 1: 'p2-rank-display', 2: 'p3-rank-display'};
            if(document.getElementById(map[pos])) document.getElementById(map[pos]).innerText = rank;
        };

        const showRank = (rankDivId, pData, posIndex) => {
            if(!pData) return;
            const el = document.getElementById(rankDivId);
            const rankNum = (rankDivId === 'podium-1') ? 1 : (rankDivId === 'podium-2' ? 2 : 3);
            
            document.getElementById(`p${rankNum}-name`).innerText = pData.name;
            document.getElementById(`p${rankNum}-avatar`).innerText = pData.avatar;
            document.getElementById(`p${rankNum}-score`).innerText = pData.score + " PTS";
            
            updateRankNum(posIndex, pData.rank);

            setTimeout(() => { 
                el.classList.remove('podium-hidden');
                el.classList.add('podium-enter'); 
            }, posIndex * 300);
        };

        if(list[0]) showRank('podium-1', list[0], 0); 
        if(list[1]) showRank('podium-2', list[1], 1);
        if(list[2]) showRank('podium-3', list[2], 2);
    }

    function showFullRankingList(list) {
        showView('view-rankings');
        if(state.role === 'host') document.getElementById('host-restart-area').classList.remove('hidden');

        const tbody = document.getElementById('ranking-list-body');
        tbody.innerHTML = '';
        if(!list) return;

        list.forEach((p, idx) => {
            const rank = p.rank || (idx + 1);
            let colorClass = "text-white";
            if(rank === 1) colorClass = "text-yellow-400 font-bold";
            else if(rank === 2) colorClass = "text-slate-300 font-bold";
            else if(rank === 3) colorClass = "text-orange-400 font-bold";

            const tr = document.createElement('tr');
            tr.className = "border-b border-slate-700/50 hover:bg-slate-800/50 transition-colors";
            tr.innerHTML = `<td class="p-3 ${colorClass}">${rank}</td>
                            <td class="p-3 flex items-center gap-3"><span class="text-2xl">${p.avatar}</span><span class="font-bold text-white">${p.name} ${p.name===state.playerName?'(YOU)':''}</span></td>
                            <td class="p-3 text-right font-mono text-cyan-400 text-xl font-bold">${p.score}</td>`;
            tbody.appendChild(tr);
        });
    }

    function backToMenu() {
        location.href = location.pathname;
    }
</script>
</body>
</html>