<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Math Arena V21: HK S1 Edition</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Black+Ops+One&family=Roboto+Mono:wght@500;700&display=swap');
        
        body { background-color: #050510; color: white; touch-action: none; user-select: none; font-family: 'Roboto Mono', monospace; overflow: hidden; }
        .font-display { font-family: 'Black Ops One', cursive; }
        .neon-text { text-shadow: 0 0 10px #22d3ee; }
        .btn-primary { @apply bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-3 px-6 rounded-lg shadow-[0_0_15px_rgba(8,145,178,0.5)] transform transition active:scale-95 w-full mb-3; }
        .btn-topic { @apply bg-slate-800 hover:bg-slate-700 border border-slate-600 text-cyan-400 font-bold py-4 rounded-xl shadow-lg transition-all active:scale-95 flex flex-col items-center justify-center gap-2; }
        .btn-topic.selected { @apply bg-cyan-900 border-cyan-400 text-white shadow-[0_0_15px_rgba(34,211,238,0.4)]; }

        /* Avatar & Game Styles */
        .avatar-btn { @apply text-4xl p-2 rounded-xl border-2 border-slate-700 transition-all cursor-pointer grayscale opacity-70 bg-slate-800; }
        .avatar-btn.selected { @apply bg-slate-800 grayscale-0 opacity-100 scale-110 z-10 border-[#fbbf24] shadow-[0_0_20px_rgba(251,191,36,0.6)]; }
        .avatar-btn.taken { @apply opacity-20 cursor-not-allowed border-red-900 bg-slate-900 scale-90 grayscale; }
        .lane-item { position: absolute; left: 0; right: 0; transition: top 0.5s ease-in-out; }
        .progress-bar { transition: width 0.3s linear; }

        @keyframes podium-up { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .podium-enter { animation: podium-up 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
    </style>
</head>
<body class="h-screen flex flex-col items-center justify-center bg-[#050510]">

    <div id="view-menu" class="text-center p-4 w-full max-w-md hidden z-50">
        <h1 class="text-6xl font-display italic text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-purple-500 mb-2 neon-text">MATH<br>ARENA</h1>
        <div class="text-xl text-slate-400 font-display mb-8">HK S1 EDITION</div>
        <div id="db-status" class="text-xs text-red-500 font-bold mb-4">üî¥ Connecting...</div>
        <button onclick="setupHost()" class="btn-primary border-l-4 border-cyan-300 text-xl py-6">üì° HOST GAME</button>
    </div>

    <div id="view-topic-select" class="w-full h-full p-6 hidden flex-col max-w-4xl mx-auto z-50">
        <h2 class="text-3xl text-cyan-400 font-display mb-2 text-center">SELECT TOPIC</h2>
        <p class="text-center text-slate-500 mb-6">Choose the HK S1 Curriculum Module</p>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 overflow-y-auto pb-20">
            <button onclick="selectTopic('area')" class="btn-topic"><span class="text-3xl">üìê</span><span>AREA &<br>SHAPES</span></button>
            <button onclick="selectTopic('volume')" class="btn-topic"><span class="text-3xl">üì¶</span><span>VOLUME</span></button>
            <button onclick="selectTopic('equation')" class="btn-topic"><span class="text-3xl">‚öñÔ∏è</span><span>LINEAR<br>EQUATION</span></button>
            <button onclick="selectTopic('percent')" class="btn-topic"><span class="text-3xl">üíØ</span><span>PERCENTAGE</span></button>
            <button onclick="selectTopic('directed')" class="btn-topic"><span class="text-3xl">‚ûï‚ûñ</span><span>DIRECTED<br>NUMBERS</span></button>
            <button onclick="selectTopic('angles')" class="btn-topic"><span class="text-3xl">üìè</span><span>LINES &<br>ANGLES</span></button>
            <button onclick="selectTopic('coord')" class="btn-topic"><span class="text-3xl">üåê</span><span>COORDINATES</span></button>
        </div>
    </div>

    <div id="view-host-lobby" class="w-full h-full p-6 hidden flex-col max-w-4xl mx-auto">
        <div class="flex justify-between items-end border-b border-slate-700 pb-2 mb-6">
            <h2 class="text-3xl text-cyan-400 font-display">LOBBY</h2>
            <div class="text-yellow-400 font-bold" id="lobby-topic-display">TOPIC: ???</div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 h-full">
            <div class="bg-slate-900 p-6 rounded-xl border border-slate-700 flex flex-col items-center">
                <div class="bg-white p-2 rounded-lg mb-4"><div id="qrcode"></div></div>
                <div class="text-2xl font-bold text-white mb-2" id="join-count-display">0 PLAYERS</div>
                <div id="player-grid" class="mt-4 flex flex-wrap justify-center gap-2 w-full max-h-60 overflow-y-auto"></div>
            </div>
            <div class="bg-slate-900 p-6 rounded-xl border border-slate-700 flex flex-col">
                <div class="mb-6">
                    <label class="block text-slate-400 text-sm mb-2 font-bold">MODE</label>
                    <div class="grid grid-cols-2 gap-2">
                        <button id="btn-mode-score" class="border border-slate-600 text-slate-400 py-2 rounded" onclick="setMode('score')">üèÅ Score</button>
                        <button id="btn-mode-time" class="border border-cyan-500 text-cyan-400 bg-cyan-900/50 py-2 rounded" onclick="setMode('time')">‚è±Ô∏è Timer</button>
                    </div>
                </div>
                <div class="mb-6">
                    <label class="block text-slate-400 text-sm mb-2 font-bold" id="setting-label">TIME LIMIT</label>
                    <input type="range" id="setting-slider" class="w-full h-2 bg-slate-700 rounded-lg cursor-pointer accent-cyan-500">
                    <div class="text-right text-cyan-400 text-2xl font-bold mt-2" id="setting-value">60 SEC</div>
                </div>
                <button id="btn-host-start" onclick="hostStartGame()" class="btn-primary mt-auto bg-slate-700 text-slate-500 cursor-not-allowed opacity-50" disabled>‚è≥ WAIT FOR PLAYERS (0/2)</button>
            </div>
        </div>
    </div>

    <div id="view-host-game" class="w-full h-full p-4 hidden flex-col bg-slate-950 relative">
        <div class="flex justify-between items-center mb-4 px-4 py-2 bg-slate-900/80 rounded-lg border border-slate-700">
            <div class="font-display text-2xl italic text-slate-300">LIVE</div>
            <div class="text-4xl font-mono font-bold text-cyan-400 neon-text" id="host-timer-display">00:00</div>
            <div class="text-sm text-slate-500 font-bold" id="host-target-display">--</div>
        </div>
        <div class="flex-1 relative mx-4 rounded-xl bg-slate-900/30 border border-slate-800 overflow-y-auto" id="lanes-container"></div>
        <div id="host-status-msg" class="absolute bottom-10 left-0 w-full text-center pointer-events-none opacity-0 transition-opacity duration-500">
            <span class="bg-black/80 text-yellow-400 px-6 py-2 rounded-full text-xl font-bold border border-yellow-500">üõë TIME UP</span>
        </div>
    </div>

    <div id="view-join" class="text-center p-6 max-w-md w-full hidden z-50">
        <h2 class="text-2xl font-bold mb-6 text-cyan-400">YOUR NAME</h2>
        <input type="text" id="player-name" placeholder="NAME" maxlength="8" class="w-full p-4 rounded bg-slate-900 border-2 border-slate-700 text-white text-center text-xl mb-4 focus:border-cyan-500 uppercase font-display">
        <button onclick="goToAvatarSelect()" class="btn-primary">NEXT</button>
    </div>

    <div id="view-avatar-select" class="text-center p-6 max-w-md w-full hidden z-50 flex-col">
        <h2 class="text-xl font-bold mb-4 text-cyan-400">SELECT AVATAR</h2>
        <div class="grid grid-cols-4 gap-4 mb-8" id="avatar-grid"></div>
        <button onclick="confirmJoin()" class="btn-primary" id="btn-join-confirm" disabled>READY</button>
    </div>

    <div id="view-student-wait" class="text-center p-6 w-full hidden z-50">
        <div class="text-6xl mb-4 animate-bounce">‚è≥</div>
        <h2 class="text-2xl font-bold text-white mb-2">WAITING...</h2>
        <div class="mt-8 p-4 bg-slate-900 rounded border border-slate-700 flex flex-col items-center">
            <div id="my-final-avatar" class="text-5xl mb-2"></div>
            <span id="my-final-name" class="font-bold text-cyan-400"></span>
            <div id="client-topic-wait" class="text-sm text-slate-500 mt-2"></div>
        </div>
    </div>

    <div id="view-game" class="w-full h-full flex flex-col hidden relative bg-slate-900">
        <div id="game-freeze-overlay" class="absolute inset-0 bg-slate-950/95 z-40 hidden flex flex-col items-center justify-center">
            <div class="text-6xl mb-4">üõë</div>
            <h2 class="text-4xl font-display text-red-500 mb-2 neon-text">FINISHED</h2>
        </div>
        <div class="h-12 bg-slate-950 border-b border-slate-800 flex justify-between items-center px-4">
            <div class="text-cyan-400 font-bold" id="client-score">0 PTS</div>
            <div class="text-slate-400 font-mono" id="client-timer-display">--:--</div>
        </div>
        <div class="flex-1 relative flex justify-center items-center overflow-hidden" id="canvas-container">
            <canvas id="gameCanvas"></canvas>
            <div id="feedback-msg" class="absolute top-1/3 left-1/2 -translate-x-1/2 text-4xl font-black opacity-0 pointer-events-none z-30"></div>
        </div>
        <div class="bg-slate-900 border-t border-slate-800 p-2 h-[45vh] grid grid-rows-[auto_1fr] gap-2 z-10 shrink-0">
            <div class="bg-slate-800/50 rounded p-2 flex flex-col justify-center items-center relative border border-slate-700">
                <div id="input-display" class="text-3xl font-mono font-bold tracking-[0.2em] text-white">_</div>
                <div id="hint-display" class="text-xs text-yellow-500/80 font-mono mt-1"></div>
            </div>
            <div class="grid grid-cols-3 gap-1 h-full pb-safe" id="keypad-grid">
                <button class="key-btn" onclick="input('7')">7</button><button class="key-btn" onclick="input('8')">8</button><button class="key-btn" onclick="input('9')">9</button>
                <button class="key-btn" onclick="input('4')">4</button><button class="key-btn" onclick="input('5')">5</button><button class="key-btn" onclick="input('6')">6</button>
                <button class="key-btn" onclick="input('1')">1</button><button class="key-btn" onclick="input('2')">2</button><button class="key-btn" onclick="input('3')">3</button>
                <button class="key-btn bg-rose-900/40 text-rose-500" onclick="input('DEL')">DEL</button>
                <button class="key-btn" onclick="input('0')">0</button>
                <button class="key-btn bg-gradient-to-b from-emerald-600 to-emerald-800 text-white" onclick="checkAnswer()">GO</button>
            </div>
        </div>
    </div>

    <div id="view-podium" class="text-center w-full hidden z-[100] bg-slate-950 absolute inset-0 flex flex-col items-center justify-center">
        <h1 class="text-5xl font-display text-transparent bg-clip-text bg-gradient-to-b from-yellow-300 to-yellow-600 mb-12 neon-gold z-10">CHAMPIONS</h1>
        <div class="flex items-end justify-center w-full max-w-4xl px-2 z-10" id="podium-container">
            <div id="podium-2" class="flex flex-col items-center mx-2 opacity-0"><div class="text-4xl mb-2" id="p2-avatar"></div><div class="text-white text-sm" id="p2-name"></div><div class="w-24 h-32 bg-slate-700 rounded-t-lg border-t-4 border-slate-400 flex items-end justify-center pb-2"><span class="text-3xl font-black text-slate-500">2</span></div><div class="text-cyan-400 font-bold" id="p2-score"></div></div>
            <div id="podium-1" class="flex flex-col items-center mx-2 opacity-0 z-20"><div class="text-7xl mb-2 animate-bounce" id="p1-avatar"></div><div class="text-yellow-400 font-bold text-xl neon-gold" id="p1-name"></div><div class="w-32 h-48 bg-gradient-to-b from-yellow-600 to-yellow-800 rounded-t-lg border-t-4 border-yellow-400 flex items-end justify-center pb-4"><span class="text-5xl font-black text-yellow-900/50">1</span></div><div class="text-yellow-400 text-2xl font-black" id="p1-score"></div></div>
            <div id="podium-3" class="flex flex-col items-center mx-2 opacity-0"><div class="text-4xl mb-2" id="p3-avatar"></div><div class="text-white text-sm" id="p3-name"></div><div class="w-24 h-24 bg-orange-900 rounded-t-lg border-t-4 border-orange-700 flex items-end justify-center pb-2"><span class="text-3xl font-black text-orange-900/50">3</span></div><div class="text-cyan-400 font-bold" id="p3-score"></div></div>
        </div>
    </div>
    <div id="view-rankings" class="w-full h-full hidden z-[101] bg-slate-950 absolute inset-0 flex flex-col p-6">
        <h2 class="text-3xl font-display text-cyan-400 text-center mb-6">FINAL STANDINGS</h2>
        <div class="flex-1 overflow-y-auto bg-slate-900/50 rounded-xl border border-slate-800 p-4 max-w-2xl mx-auto w-full">
            <table class="w-full text-left border-collapse"><tbody id="ranking-list-body"></tbody></table>
        </div>
        <div class="mt-4 text-center"><button onclick="location.reload()" class="btn-primary max-w-xs bg-slate-700">üè† HOME</button></div>
    </div>

<script>
    // --- FIREBASE CONFIG ---
    const firebaseConfig = { apiKey: "AIzaSyAYnQB2o5cPn42RiNAik7537ihduICJwdQ", authDomain: "fwftmath.firebaseapp.com", projectId: "fwftmath", storageBucket: "fwftmath.firebasestorage.app", messagingSenderId: "70090299689", appId: "1:70090299689:web:ae300db1f79a3eda62bf38" };
    let app, db;
    try { app = firebase.initializeApp(firebaseConfig); db = firebase.database(); 
        db.ref(".info/connected").on("value", s => document.getElementById('db-status').innerText = s.val()?"üü¢ ONLINE":"üü† CONNECTING...");
    } catch(e){console.error(e);}

    // --- GAME STATE & CONSTANTS ---
    const AVATARS = ['üêØ','üê∞','ü¶Å','ü¶Ñ','ü¶ñ','üëΩ','ü§ñ','üêº','ü¶ä','üê®','üêÆ','üê∑'];
    const AUDIO = new (window.AudioContext||window.webkitAudioContext)();
    function beep(f,t,d){if(AUDIO.state==='suspended')AUDIO.resume();const o=AUDIO.createOscillator(),g=AUDIO.createGain();o.type=t;o.frequency.value=f;o.connect(g);g.connect(AUDIO.destination);o.start();g.gain.exponentialRampToValueAtTime(0.001,AUDIO.currentTime+d);o.stop(AUDIO.currentTime+d);}

    let state = {
        role: 'none', gid: new URLSearchParams(location.search).get('gid'), pid: 'p_'+Math.random().toString(36).substr(2,6),
        name: 'Guest', av: '', score: 0, active: false,
        settings: { mode: 'time', target: 60, topic: 'area' }, // Added topic
        q: null, input: '', lastType: null
    };

    // --- VIEW MANAGEMENT ---
    const views = ['view-menu','view-topic-select','view-host-lobby','view-host-game','view-join','view-avatar-select','view-student-wait','view-game','view-podium','view-rankings'];
    function show(id) { views.forEach(v=>document.getElementById(v).classList.add('hidden')); document.getElementById(id).classList.remove('hidden'); if(id.includes('host')||id.includes('flex'))document.getElementById(id).classList.add('flex'); if(id==='view-game')resize(); }
    window.onload=()=>state.gid?show('view-join'):show('view-menu');

    // --- HOST FUNCTIONS ---
    function setupHost() { 
        if(!db)return; state.role='host'; 
        show('view-topic-select'); // Step 1: Select Topic
    }

    function selectTopic(topic) {
        state.settings.topic = topic;
        const ref = db.ref('games').push();
        state.gid = ref.key;
        ref.set({ status: 'lobby', settings: state.settings });
        
        show('view-host-lobby');
        document.getElementById('lobby-topic-display').innerText = "TOPIC: " + topic.toUpperCase().replace('_',' ');
        
        new QRCode(document.getElementById("qrcode"), { text: `${location.origin}${location.pathname}?gid=${state.gid}`, width:128, height:128 });
        
        db.ref(`games/${state.gid}/players`).on('value', snap => {
            const grid=document.getElementById('player-grid'), count=snap.numChildren();
            grid.innerHTML=''; 
            snap.forEach(c => grid.innerHTML+=`<div class="bg-slate-800 px-3 py-2 rounded border border-slate-600 flex gap-2"><span class="text-xl">${c.val().avatar}</span><span class="font-bold">${c.val().name}</span></div>`);
            document.getElementById('join-count-display').innerText = `${count} PLAYERS`;
            
            const btn = document.getElementById('btn-host-start');
            if(count>=2) { btn.disabled=false; btn.className="btn-primary mt-auto bg-gradient-to-r from-green-500 to-emerald-600 text-2xl py-4"; btn.innerText="üöÄ START GAME"; }
            else { btn.disabled=true; btn.className="btn-primary mt-auto bg-slate-700 text-slate-500 opacity-50 cursor-not-allowed"; btn.innerText=`‚è≥ WAIT (${count}/2)`; }
        });
        
        setMode('time'); // Default
    }

    function setMode(m) {
        state.settings.mode = m;
        const s = document.getElementById('setting-slider'), l = document.getElementById('setting-label');
        if(m==='score') { l.innerText="TARGET SCORE"; s.min=500; s.max=5000; s.step=100; s.value=1000; }
        else { l.innerText="TIME LIMIT"; s.min=30; s.max=300; s.step=10; s.value=60; }
        s.oninput();
    }
    document.getElementById('setting-slider').oninput = function() {
        const v = parseInt(this.value);
        state.settings.target = v;
        document.getElementById('setting-value').innerText = state.settings.mode==='score' ? v+" PTS" : v+" SEC";
        if(state.gid) db.ref(`games/${state.gid}/settings`).update(state.settings);
    };

    function hostStartGame() {
        if(document.getElementById('join-count-display').innerText.charAt(0) < '2') return;
        const end = state.settings.mode==='time' ? Date.now()+(state.settings.target*1000) : 0;
        db.ref(`games/${state.gid}`).update({ status: 'playing', startTime: Date.now(), endTime: end });
        show('view-host-game');
        
        let loop = setInterval(() => {
            if(state.settings.mode==='time' && Date.now() >= end) { clearInterval(loop); finishGame(); }
        }, 1000);

        // Host Timer UI
        let uiLoop = setInterval(() => {
            const el = document.getElementById('host-timer-display');
            if(state.settings.mode==='time') {
                let left = Math.ceil((end - Date.now())/1000);
                if(left<=0) { el.innerText="00:00"; clearInterval(uiLoop); }
                else el.innerText = `${Math.floor(left/60)}:${(left%60).toString().padStart(2,'0')}`;
            } else { el.innerText = "RACE"; }
        }, 500);

        db.ref(`games/${state.gid}/players`).on('value', snap => {
            const players=[]; snap.forEach(c=>players.push(c.val()));
            players.sort((a,b)=>(b.score||0)-(a.score||0));
            
            // Check Score Win
            if(state.settings.mode==='score' && players[0]?.score >= state.settings.target) { clearInterval(loop); finishGame(); }

            // Render Lanes
            const con = document.getElementById('lanes-container');
            const max = state.settings.mode==='score' ? state.settings.target : Math.max(state.settings.target*10, (players[0]?.score||0)*1.2);
            players.forEach((p,i) => {
                let lane = document.getElementById('lane-'+p.name);
                if(!lane) {
                    lane = document.createElement('div'); lane.id='lane-'+p.name;
                    lane.className = 'lane-item h-12 bg-slate-800/80 rounded flex items-center px-2 border border-slate-700 shadow mx-2 mb-2';
                    lane.innerHTML = `<div class="w-8 text-2xl">${p.avatar}</div><div class="w-20 truncate font-bold text-sm">${p.name}</div><div class="flex-1 h-3 bg-slate-900 rounded-full mx-2"><div class="progress-bar h-full bg-cyan-500" style="width:0%"></div></div><div class="w-12 text-right font-mono font-bold text-cyan-400 p-score">0</div>`;
                    con.appendChild(lane);
                }
                lane.style.top = (i*60)+'px';
                lane.querySelector('.progress-bar').style.width = Math.min(100, (p.score/max)*100)+'%';
                lane.querySelector('.p-score').innerText = p.score;
            });
        });
    }

    function finishGame() {
        db.ref(`games/${state.gid}`).update({ status: 'finished' });
        document.getElementById('host-status-msg').style.opacity=1;
        setTimeout(() => {
            db.ref(`games/${state.gid}/players`).once('value', s => {
                const arr=[]; s.forEach(c=>arr.push(c.val()));
                arr.sort((a,b)=>b.score-a.score);
                db.ref(`games/${state.gid}`).update({ status: 'results', finalStandings: arr });
            });
        }, 2000);
    }

    // --- CLIENT FUNCTIONS ---
    function goToAvatarSelect() {
        if(!document.getElementById('player-name').value) return;
        state.name = document.getElementById('player-name').value;
        show('view-avatar-select');
        const grid = document.getElementById('avatar-grid'); grid.innerHTML='';
        AVATARS.forEach((a,i) => {
            const b=document.createElement('div'); b.className='avatar-btn'; b.innerText=a;
            b.onclick=()=> { document.querySelectorAll('.avatar-btn').forEach(x=>x.classList.remove('selected')); b.classList.add('selected'); state.av=a; document.getElementById('btn-join-confirm').disabled=false; };
            grid.appendChild(b);
        });
    }

    function confirmJoin() {
        db.ref(`games/${state.gid}/players/${state.pid}`).set({ name: state.name, avatar: state.av, score: 0 });
        show('view-student-wait');
        document.getElementById('my-final-avatar').innerText = state.av;
        document.getElementById('my-final-name').innerText = state.name;

        db.ref(`games/${state.gid}`).on('value', snap => {
            const g = snap.val();
            if(!g) return;
            state.settings = g.settings;
            document.getElementById('client-topic-wait').innerText = "Topic: " + g.settings.topic.toUpperCase();

            if(g.status === 'playing') {
                if(!state.active) {
                    state.active = true;
                    show('view-game');
                    setupKeypad(state.settings.topic); // Setup Keypad based on Topic
                    generateQuestion();
                    startClientTimer(g.endTime);
                }
            } else if(g.status === 'finished') {
                state.active = false;
                document.getElementById('game-freeze-overlay').classList.remove('hidden');
            } else if(g.status === 'results') {
                showResults(g.finalStandings);
            }
        });
    }

    function startClientTimer(end) {
        const el = document.getElementById('client-timer-display');
        setInterval(() => {
            if(!end) { el.innerText="RACE"; return; }
            let left = Math.ceil((end-Date.now())/1000);
            if(left<=0) el.innerText="00:00";
            else el.innerText = `${Math.floor(left/60)}:${(left%60).toString().padStart(2,'0')}`;
        }, 500);
    }

    // --- MATH ENGINE V21 ---
    const cvs = document.getElementById('gameCanvas');
    const ctx = cvs.getContext('2d');
    function resize() { const p=document.getElementById('canvas-container'); cvs.width=p.clientWidth; cvs.height=p.clientHeight; if(state.q) draw(); }
    window.onresize=resize;

    // KEYPAD CONFIG
    function setupKeypad(topic) {
        // If topic needs negative numbers (Equation, Directed, Coord), replace a key
        // Currently we replaced DEL button row. Let's make "0" smaller or replace an empty slot if any.
        // My design has 12 slots. 0-9, DEL, GO.
        // To add '-', I need to modify the grid dynamically.
        const grid = document.getElementById('keypad-grid');
        const needsMinus = ['equation', 'directed', 'coord'].includes(topic);
        
        let html = '';
        const keys = [7,8,9,4,5,6,1,2,3];
        keys.forEach(k => html += `<button class="key-btn bg-slate-800 text-cyan-100 rounded text-2xl font-bold active:bg-cyan-700" onclick="input('${k}')">${k}</button>`);
        
        if(needsMinus) {
            html += `<button class="key-btn bg-slate-800 text-cyan-100 rounded text-2xl font-bold" onclick="input('-')">-</button>`;
            html += `<button class="key-btn bg-slate-800 text-cyan-100 rounded text-2xl font-bold" onclick="input('0')">0</button>`;
            html += `<button class="key-btn bg-rose-900/40 text-rose-500 rounded font-bold" onclick="input('DEL')">‚å´</button>`;
        } else {
            html += `<button class="key-btn bg-rose-900/40 text-rose-500 rounded font-bold" onclick="input('DEL')">‚å´</button>`;
            html += `<button class="key-btn bg-slate-800 text-cyan-100 rounded text-2xl font-bold" onclick="input('0')">0</button>`;
            html += `<button class="key-btn bg-slate-800 opacity-0 pointer-events-none"></button>`; // Empty filler
        }
        
        // Add GO button wide at bottom or integrated? 
        // The previous design had 4x3? No 3 cols.
        // Let's stick to the 3-column grid in HTML and just inject buttons.
        // Wait, the HTML has a fixed grid. Let's rewrite innerHTML.
        
        // Revised layout: 4 Rows of 3 Cols
        // 7 8 9
        // 4 5 6
        // 1 2 3
        // - 0 DEL (if minus needed)
        // OR
        // DEL 0 GO (Standard)
        
        let btmRow = '';
        if(needsMinus) {
            btmRow = `<button class="bg-slate-700 text-yellow-400 rounded text-2xl font-bold" onclick="input('-')">-</button>
                      <button class="bg-slate-800 text-cyan-100 rounded text-2xl font-bold" onclick="input('0')">0</button>
                      <button class="bg-rose-900/40 text-rose-500 rounded font-bold" onclick="input('DEL')">‚å´</button>`;
        } else {
             btmRow = `<button class="bg-rose-900/40 text-rose-500 rounded font-bold" onclick="input('DEL')">‚å´</button>
                       <button class="bg-slate-800 text-cyan-100 rounded text-2xl font-bold" onclick="input('0')">0</button>
                       <button class="bg-slate-800 text-slate-600 rounded text-xl font-bold pointer-events-none">.</button>`;
        }
        
        // We need a GO button separately or inside grid? 
        // In my HTML, GO is in the grid.
        // Let's put GO spanning whole bottom or right side.
        // Simplest: 7 8 9 | 4 5 6 | 1 2 3 | - 0 DEL | GO (Separate div?)
        // Let's use the HTML structure I wrote: grid-cols-3.
        
        grid.innerHTML = '';
        [7,8,9,4,5,6,1,2,3].forEach(n => {
            grid.innerHTML += `<button class="bg-slate-800 text-cyan-100 rounded text-2xl font-bold active:bg-cyan-700 shadow" onclick="input('${n}')">${n}</button>`;
        });
        
        if(needsMinus) {
            grid.innerHTML += `<button class="bg-slate-700 text-yellow-400 rounded text-2xl font-bold shadow" onclick="input('-')">-</button>`;
            grid.innerHTML += `<button class="bg-slate-800 text-cyan-100 rounded text-2xl font-bold shadow" onclick="input('0')">0</button>`;
            grid.innerHTML += `<button class="bg-rose-900/40 text-rose-500 rounded font-bold shadow" onclick="input('DEL')">DEL</button>`;
        } else {
             grid.innerHTML += `<button class="bg-rose-900/40 text-rose-500 rounded font-bold shadow" onclick="input('DEL')">DEL</button>`;
             grid.innerHTML += `<button class="bg-slate-800 text-cyan-100 rounded text-2xl font-bold shadow" onclick="input('0')">0</button>`;
             grid.innerHTML += `<div class="bg-transparent"></div>`;
        }
        
        // Append GO button usually occupies a big chunk or separate.
        // I'll make the keypad grid 3 columns, 4 rows.
        // The 'GO' button is outside in the HTML structure? 
        // Ah, I see in HTML: grid-cols-3 gap-1.
        // Let's just append GO at the very end as a span-3 button if possible, or keep it in the flow.
        // To make it clean: The Grid is strictly numbers. The GO button should be separate or the last item.
        
        // Quick fix: Add GO as a large button below the grid in CSS, 
        // OR add it as the 4th row item.
        // Let's just add it to the grid.
        grid.innerHTML += `<button class="col-span-3 bg-gradient-to-b from-emerald-600 to-emerald-800 text-white rounded font-bold text-xl py-2 active:translate-y-1 shadow-lg mt-1" onclick="checkAnswer()">GO</button>`;
    }

    function generateQuestion() {
        const r = (a,b) => Math.floor(Math.random()*(b-a+1))+a;
        const topic = state.settings.topic;
        const diff = state.score > 500 ? 'hard' : 'easy';
        let q = { type: topic, ans: 0 };
        let hint = "";

        // --- 1. AREA ---
        if(topic === 'area') {
            const shapes = diff==='easy'?['rect','para']:['tri','trap','comp'];
            const shape = shapes[r(0,shapes.length-1)];
            q.shape = shape;
            if(shape==='rect') { q.w=r(5,12); q.h=r(4,9); q.ans=q.w*q.h; hint="Area = W √ó H"; }
            else if(shape==='para') { q.b=r(5,12); q.h=r(4,9); q.ans=q.b*q.h; hint="Area = B √ó H"; }
            else if(shape==='tri') { q.b=r(6,14); q.h=r(4,10); if(q.b%2)q.b++; q.ans=(q.b*q.h)/2; hint="Area = B √ó H √∑ 2"; }
            else if(shape==='trap') { q.t=r(4,8); q.b=q.t+r(2,6); q.h=r(4,8); if((q.t+q.b)*q.h%2)q.h++; q.ans=((q.t+q.b)*q.h)/2; hint="Area = (Top+Btm)√óH√∑2"; }
            else { q.w=r(8,12); q.h=r(8,12); q.cw=r(3,5); q.ch=r(3,5); q.ans=(q.w*q.h)-(q.cw*q.ch); hint="Rect - Cut"; }
        }
        
        // --- 2. VOLUME ---
        else if(topic === 'volume') {
            q.shape = 'cuboid';
            if(diff==='easy') {
                q.l=r(3,8); q.w=r(2,6); q.h=r(2,6);
                q.ans = q.l*q.w*q.h;
                hint = "Vol = L √ó W √ó H";
            } else {
                // Prism Base Area * Height
                q.shape = 'prism';
                q.area = r(12,30); q.h=r(4,10);
                q.ans = q.area * q.h;
                hint = "Vol = Base Area √ó H";
            }
        }

        // --- 3. EQUATION (ax + b = c) ---
        else if(topic === 'equation') {
            // Generates x first to ensure integer answer
            const x = r(-9,9);
            const a = r(2,6) * (Math.random()<.5?1:-1);
            const b = r(-10,10);
            const c = (a*x) + b;
            q.txt = `${a}x ${b>=0?'+ '+b:'- '+Math.abs(b)} = ${c}`;
            q.ans = x;
            hint = "Solve for x";
        }

        // --- 4. PERCENTAGE ---
        else if(topic === 'percent') {
            if(diff==='easy') {
                // X% of Y
                const p = r(1,9)*10; // 10, 20...90
                const y = r(2,20)*5; // 10, 15...100
                q.txt = `${p}% of ${y} = ?`;
                q.ans = (p/100)*y;
            } else {
                // Discount / Change
                const p = r(1,5)*10;
                const y = r(5,15)*10;
                const isInc = Math.random()>.5;
                q.txt = `${y} ${isInc?'increased':'decreased'}\nby ${p}%`;
                q.ans = isInc ? y*(1+p/100) : y*(1-p/100);
            }
            hint = "Calculate Value";
        }

        // --- 5. DIRECTED NUMBERS ---
        else if(topic === 'directed') {
            const n1 = r(-12, 12);
            const n2 = r(-12, 12);
            const ops = ['+','-','√ó'];
            const op = ops[r(0,2)];
            // Avoid complicated division for now
            if(op==='+') q.ans = n1 + n2;
            else if(op==='-') q.ans = n1 - n2;
            else if(op==='√ó') q.ans = n1 * n2;
            
            // Format: (-5) + (-3)
            const fmt = n => n<0 ? `(${n})` : n;
            q.txt = `${fmt(n1)} ${op} ${fmt(n2)}`;
            hint = "Watch the signs";
        }

        // --- 6. ANGLES ---
        else if(topic === 'angles') {
            q.subType = diff==='easy' ? (Math.random()>.5?'vert':'supp') : 'comp'; 
            // vert = vertically opposite (equal)
            // supp = straight line (sum 180)
            // comp = right angle (sum 90)
            
            if(q.subType === 'vert') {
                q.ans = r(30, 150);
                q.angleKnown = q.ans; 
                hint = "Vertically Opposite";
            } else if (q.subType === 'supp') {
                q.ans = r(30, 150);
                q.angleKnown = 180 - q.ans;
                hint = "Straight Line = 180¬∞";
            } else {
                q.ans = r(20, 70);
                q.angleKnown = 90 - q.ans;
                hint = "Right Angle = 90¬∞";
            }
        }

        // --- 7. COORDINATES ---
        else if(topic === 'coord') {
            // Show a point, ask for X or Y coordinate
            q.x = r(-5, 5);
            q.y = r(-5, 5);
            if(q.x===0) q.x++; if(q.y===0) q.y--; // Avoid origin ambiguity
            
            q.ask = Math.random() > 0.5 ? 'x' : 'y';
            q.ans = q.ask === 'x' ? q.x : q.y;
            hint = `Find ${q.ask.toUpperCase()}-coordinate`;
        }

        state.q = q;
        state.input = '';
        document.getElementById('input-display').innerText = '_';
        document.getElementById('hint-display').innerText = hint;
        draw();
    }

    function draw() {
        const w=cvs.width, h=cvs.height, cx=w/2, cy=h/2;
        ctx.clearRect(0,0,w,h);
        ctx.strokeStyle='#22d3ee'; ctx.fillStyle='#fff'; ctx.lineWidth=3;
        ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.font='bold 24px Roboto Mono';

        // Helper
        const label = (t,x,y,c='#fbbf24') => { ctx.fillStyle='#0f172a'; ctx.fillRect(x-12,y-12,24,24); ctx.fillStyle=c; ctx.fillText(t,x,y); };

        if(state.q.type === 'area') {
            // ... (Same drawing logic as V20, abbreviated for space)
            const s=Math.min(w,h)/20;
            // Simplified drawing for brevity in V21
            if(state.q.shape==='rect') { ctx.strokeRect(cx-state.q.w*s/2, cy-state.q.h*s/2, state.q.w*s, state.q.h*s); label(state.q.w,cx,cy-state.q.h*s/2-20); label(state.q.h,cx+state.q.w*s/2+20,cy); }
            else if(state.q.shape==='tri') { ctx.beginPath(); ctx.moveTo(cx,cy-state.q.h*s/2); ctx.lineTo(cx-state.q.b*s/2,cy+state.q.h*s/2); ctx.lineTo(cx+state.q.b*s/2,cy+state.q.h*s/2); ctx.closePath(); ctx.stroke(); label(state.q.b,cx,cy+state.q.h*s/2+20); label(state.q.h,cx+10,cy); }
            // Add other shapes as needed
            else { ctx.fillText(state.q.shape.toUpperCase(), cx, cy); }
        }
        else if(state.q.type === 'volume') {
             // Draw basic 3D Cube representation
             const s = 30; 
             const dx=20, dy=20;
             if(state.q.shape==='cuboid') {
                ctx.strokeRect(cx-50, cy-50, 100, 100); // Front
                ctx.beginPath(); ctx.moveTo(cx-50,cy-50); ctx.lineTo(cx-50+dx,cy-50-dy); ctx.lineTo(cx+50+dx,cy-50-dy); ctx.lineTo(cx+50+dx,cy+50-dy); ctx.lineTo(cx+50,cy+50); ctx.stroke();
                ctx.moveTo(cx+50+dx,cy-50-dy); ctx.lineTo(cx+50,cy-50); ctx.stroke();
                label(state.q.l, cx, cy+60); label(state.q.h, cx-60, cy); label(state.q.w, cx+60, cy-60);
             } else {
                 ctx.font='20px Roboto Mono';
                 ctx.fillText(`Base Area = ${state.q.area}`, cx, cy-20);
                 ctx.fillText(`Height = ${state.q.h}`, cx, cy+20);
             }
        }
        else if(state.q.type === 'equation' || state.q.type === 'percent' || state.q.type === 'directed') {
            ctx.font='bold 32px Roboto Mono';
            ctx.fillStyle = '#a5f3fc';
            const lines = state.q.txt.split('\n');
            lines.forEach((l,i) => ctx.fillText(l, cx, cy + (i*40) - ((lines.length-1)*20)));
        }
        else if(state.q.type === 'angles') {
            const len = 100;
            ctx.beginPath();
            if(state.q.subType === 'comp') {
                // Right angle L shape
                ctx.moveTo(cx-len, cy+20); ctx.lineTo(cx, cy+20); ctx.lineTo(cx, cy-len); ctx.stroke();
                // Splitter
                const rad = (state.q.angleKnown * Math.PI)/180;
                ctx.moveTo(cx, cy+20); ctx.lineTo(cx - Math.cos(rad)*len, cy+20 - Math.sin(rad)*len); ctx.stroke();
                // Square mark
                ctx.strokeRect(cx-15,cy+5,15,15);
                ctx.fillText(state.q.angleKnown+'¬∞', cx-30, cy-40);
                ctx.fillStyle='#fbbf24'; ctx.fillText('?', cx-60, cy);
            } else if(state.q.subType === 'supp') {
                // Straight line
                ctx.moveTo(cx-len, cy); ctx.lineTo(cx+len, cy); ctx.stroke();
                // Splitter
                ctx.moveTo(cx, cy); ctx.lineTo(cx-30, cy-len); ctx.stroke();
                ctx.fillText(state.q.angleKnown+'¬∞', cx+20, cy-20);
                ctx.fillStyle='#fbbf24'; ctx.fillText('?', cx-30, cy-20);
            } else {
                // X shape
                ctx.moveTo(cx-len, cy-len/2); ctx.lineTo(cx+len, cy+len/2);
                ctx.moveTo(cx-len, cy+len/2); ctx.lineTo(cx+len, cy-len/2);
                ctx.stroke();
                ctx.fillText(state.q.angleKnown+'¬∞', cx, cy-40);
                ctx.fillStyle='#fbbf24'; ctx.fillText('?', cx, cy+40);
            }
        }
        else if(state.q.type === 'coord') {
            // Draw Grid
            ctx.strokeStyle = '#334155'; ctx.lineWidth=1;
            const step = 20;
            for(let i=cx-100; i<=cx+100; i+=step) { ctx.beginPath(); ctx.moveTo(i, cy-100); ctx.lineTo(i, cy+100); ctx.stroke(); }
            for(let i=cy-100; i<=cy+100; i+=step) { ctx.beginPath(); ctx.moveTo(cx-100, i); ctx.lineTo(cx+100, i); ctx.stroke(); }
            // Axes
            ctx.strokeStyle = '#94a3b8'; ctx.lineWidth=2;
            ctx.beginPath(); ctx.moveTo(cx, cy-100); ctx.lineTo(cx, cy+100); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(cx-100, cy); ctx.lineTo(cx+100, cy); ctx.stroke();
            
            // Point
            const px = cx + (state.q.x * step);
            const py = cy - (state.q.y * step); // Canvas Y is inverted
            ctx.fillStyle = '#ef4444';
            ctx.beginPath(); ctx.arc(px, py, 6, 0, Math.PI*2); ctx.fill();
            
            ctx.fillStyle = '#fff';
            ctx.fillText(`Point (${state.q.ask==='x'?'?':state.q.x}, ${state.q.ask==='y'?'?':state.q.y})`, cx, cy+130);
        }
    }

    // --- GAMEPLAY INPUT ---
    function input(k) {
        if(!state.active) return;
        if(k==='DEL') state.input = state.input.slice(0,-1);
        else if(state.input.length < 6) state.input += k;
        document.getElementById('input-display').innerText = state.input || '_';
        beep(500, 'sine', 0.05);
    }

    function checkAnswer() {
        if(!state.active || !state.input) return;
        // Allow decimals? Usually S1 start with integer or simple decimal. 
        // For simplicity, we parse float but questions mostly generate ints.
        const val = parseFloat(state.input);
        const diff = Math.abs(val - state.q.ans);
        const correct = diff < 0.01; // Tolerance for float

        const fb = document.getElementById('feedback-msg');
        if(correct) {
            state.score += 100;
            beep(800, 'triangle', 0.1);
            fb.innerText="GOOD!"; fb.style.color='#4ade80'; fb.style.opacity=1;
            db.ref(`games/${state.gid}/players/${state.pid}`).update({score: state.score});
            setTimeout(()=>{ fb.style.opacity=0; generateQuestion(); }, 400);
        } else {
            beep(150, 'sawtooth', 0.3);
            fb.innerText="MISS"; fb.style.color='#ef4444'; fb.style.opacity=1;
            setTimeout(()=>{ fb.style.opacity=0; state.input=''; document.getElementById('input-display').innerText='_'; }, 500);
        }
        document.getElementById('client-score').innerText = state.score + " PTS";
    }

    function showResults(list) {
        show('view-podium');
        const setPod = (id, p) => {
            if(!p) return;
            document.getElementById(id).style.opacity=1;
            document.getElementById(id).classList.add('podium-enter');
            document.getElementById(id.replace('podium','p')+'-name').innerText = p.name;
            document.getElementById(id.replace('podium','p')+'-avatar').innerText = p.avatar;
            document.getElementById(id.replace('podium','p')+'-score').innerText = p.score;
        };
        setPod('podium-1', list[0]);
        setTimeout(()=>setPod('podium-2', list[1]), 500);
        setTimeout(()=>setPod('podium-3', list[2]), 1000);
        
        confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });

        setTimeout(() => {
            show('view-rankings');
            const b = document.getElementById('ranking-list-body'); b.innerHTML='';
            list.forEach((p,i) => {
                b.innerHTML += `<tr class="border-b border-slate-700 text-slate-300"><td class="p-3">${i+1}</td><td class="p-3 flex gap-2"><span class="text-xl">${p.avatar}</span><b>${p.name}</b></td><td class="p-3 text-right font-mono">${p.score}</td></tr>`;
            });
        }, 5000);
    }
</script>
</body>
</html>